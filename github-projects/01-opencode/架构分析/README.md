# OpenCode 架构分析

## 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                      用户界面层                              │
├─────────────┬─────────────┬─────────────┬──────────────────┤
│   Terminal  │   Desktop   │   VSCode    │      Web         │
│     CLI     │     App     │  Extension  │    (Share)       │
└─────────────┴──────┬──────┴─────────────┴──────────────────┘
                     │
┌────────────────────▼────────────────────────────────────────┐
│                      核心引擎层                              │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │
│  │   Session   │  │    Agent    │  │      Context        │ │
│  │   Manager   │  │   Runtime   │  │      Manager        │ │
│  └─────────────┘  └─────────────┘  └─────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────────┐
│                      工具层                                  │
├─────────────┬─────────────┬─────────────┬──────────────────┤
│    File     │     Bash    │     LSP     │      Search      │
│  Operations │   Execute   │   Tools     │   (Grep/Glob)    │
└─────────────┴─────────────┴─────────────┴──────────────────┘
                     │
┌────────────────────▼────────────────────────────────────────┐
│                      模型抽象层                              │
├─────────────┬─────────────┬─────────────┬──────────────────┤
│  Anthropic  │   OpenAI    │   Google    │     Ollama       │
│   Claude    │    GPT      │   Gemini    │     Local        │
└─────────────┴─────────────┴─────────────┴──────────────────┘
```

## 核心设计原则

### 1. 终端原生（Terminal-Native）
- 不依赖特定IDE
- 命令行优先的交互方式
- 与开发者现有工作流无缝集成

### 2. 模型无关（Model-Agnostic）
- 统一的模型接口抽象
- 支持75+模型提供商
- 可随时切换模型

### 3. 隐私优先（Privacy-First）
- 不存储代码或上下文
- 本地处理为主
- 适用于敏感环境

### 4. 开源透明（Open Source）
- MIT许可证
- 500+贡献者
- 活跃的社区

## 关键技术选型

| 组件 | 技术 | 原因 |
|------|------|------|
| 核心语言 | TypeScript + Go | TS生态丰富，Go高性能 |
| 终端UI | Ink (React for CLI) | 声明式终端界面 |
| LSP集成 | 原生LSP协议 | 语言无关的智能提示 |
| 模型调用 | Models.dev | 统一的多模型接口 |

## 研究问题

1. [ ] 会话状态如何持久化？
2. [ ] 多会话如何隔离上下文？
3. [ ] LSP是如何集成的？
4. [ ] 模型切换的具体实现？
5. [ ] 工具调用的消息格式？
