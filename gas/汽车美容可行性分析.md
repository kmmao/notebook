# 汽车美容服务扩展 - 可行性分析

> 基于现有加油站管理平台扩展汽车美容业务

## 一、项目背景

| 项目 | 说明 |
|------|------|
| 现有系统 | 加油站管理平台（客户信息、加油订单） |
| 扩展目标 | 新增汽车美容服务模块 |
| 硬件投入 | 新建洗车美容房间 + 海康摄像头 |
| 核心痛点 | **用户与车牌无实际关联**（现有系统埋点） |

---

## 二、多端角色分析

### 2.1 角色概览

| 角色 | 使用端 | 核心职责 | 关键操作 |
|------|--------|----------|----------|
| 普通用户 | 微信H5/小程序 | 消费者 | 扫码消券、追加服务支付、查看订单、排队取号 |
| 洗车员工 | 员工APP | 服务执行 | 出示收券码、确认车牌、上传照片、标记服务完成 |
| 调度员 | 员工APP/PC后台 | 工位调度 | 分配工位、处理排队、异常处理 |
| 站长/店长 | PC管理后台 | 站点管理 | 员工管理、工位管理、数据查看、券配置 |
| 运营管理 | PC管理后台 | 多站点运营 | 统计报表、绩效分析、营销活动、券发放策略 |
| 系统管理员 | PC管理后台 | 系统配置 | 服务类型配置、价格配置、权限管理 |

### 2.2 各端功能矩阵

#### 用户端（微信H5/小程序）

```
┌─────────────────────────────────────────────────────────────┐
│                        用户端功能                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  首页       │  │  我的券     │  │  我的订单   │         │
│  │  - 扫码入口 │  │  - 洗车券   │  │  - 进行中   │         │
│  │  - 排队取号 │  │  - 有效期   │  │  - 历史订单 │         │
│  │  - 工位状态 │  │  - 使用记录 │  │  - 订单详情 │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  我的车辆   │  │  追加服务   │  │  支付       │         │
│  │  - 已绑车牌 │  │  - 服务列表 │  │  - 微信支付 │         │
│  │  - 服务历史 │  │  - 加购确认 │  │  - 支付记录 │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

| 功能 | 说明 | 优先级 |
|------|------|--------|
| 扫员工码消券 | 扫码 → 选券 → 确认车牌 → 开始服务 | P0 |
| 排队取号 | 到站扫码取号，查看排队进度 | P1 |
| 追加服务支付 | 服务中追加项目，H5内直接支付 | P0 |
| 订单查看 | 查看当前服务进度、历史订单 | P0 |
| 我的车辆 | 查看已绑定车牌、每辆车的服务历史 | P1 |
| 洗车券管理 | 查看持有券、有效期、使用记录 | P0 |

#### 员工端（APP）

```
┌─────────────────────────────────────────────────────────────┐
│                        员工端功能                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  我的二维码 │  │  当前订单   │  │  工位状态   │         │
│  │  - 收券码   │  │  - 服务列表 │  │  - 本工位   │         │
│  │  - 员工信息 │  │  - 追加服务 │  │  - 全站概览 │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  车牌确认   │  │  拍照上传   │  │  我的绩效   │         │
│  │  - 摄像头牌 │  │  - 外观检查 │  │  - 今日统计 │         │
│  │  - 手动输入 │  │  - 过程记录 │  │  - 月度汇总 │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

| 功能 | 说明 | 优先级 |
|------|------|--------|
| 收券二维码 | 展示个人收券码供用户扫描 | P0 |
| 车牌确认 | 确认摄像头识别的车牌，或手动输入 | P0 |
| 外观检查拍照 | 服务前上传车辆外观照片 | P0 |
| 服务操作 | 标记各服务项开始/完成 | P0 |
| 追加服务 | 为当前订单添加额外服务项 | P0 |
| 过程拍照 | 服务过程中上传照片记录 | P0 |
| 我的绩效 | 查看个人服务统计 | P1 |

#### 调度端（APP/PC）

| 功能 | 说明 | 优先级 |
|------|------|--------|
| 排队管理 | 查看排队列表，手动调整顺序 | P1 |
| 工位分配 | 将排队用户分配到空闲工位 | P1 |
| 异常处理 | 处理未扫码车辆、订单挂起等 | P1 |
| 实时看板 | 全站工位状态一览 | P1 |

#### 管理后台（PC）

```
┌─────────────────────────────────────────────────────────────┐
│                        管理后台功能                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  站点管理          员工管理          工位管理                 │
│  ├─ 站点信息       ├─ 员工列表       ├─ 工位配置             │
│  ├─ 营业时间       ├─ 角色分配       ├─ 摄像头绑定           │
│  └─ 服务配置       └─ 绩效统计       └─ 状态监控             │
│                                                             │
│  订单管理          券管理            配件管理                 │
│  ├─ 订单列表       ├─ 券类型配置     ├─ 配件目录             │
│  ├─ 订单详情       ├─ 有效期设置     ├─ 库存管理             │
│  ├─ 异常订单       ├─ 发放规则       ├─ 入库/出库            │
│  └─ 退款处理       └─ 使用统计       └─ 库存预警             │
│                                                             │
│  统计报表          服务配置                                   │
│  ├─ 服务统计       ├─ 服务类型                               │
│  ├─ 员工绩效       ├─ 服务时长                               │
│  ├─ 收入报表       ├─ 价格配置                               │
│  └─ 趋势分析       └─ 追加服务开关                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.3 权限矩阵

| 功能 | 普通用户 | 洗车员工 | 调度员 | 站长 | 运营 | 系统管理 |
|------|:--------:|:--------:|:------:|:----:|:----:|:--------:|
| 扫码消券 | ✅ | - | - | - | - | - |
| 追加服务支付 | ✅ | - | - | - | - | - |
| 出示收券码 | - | ✅ | ✅ | ✅ | - | - |
| 车牌确认 | - | ✅ | ✅ | ✅ | - | - |
| 服务操作 | - | ✅ | - | - | - | - |
| 追加服务 | - | ✅ | - | - | - | - |
| 排队调度 | - | - | ✅ | ✅ | - | - |
| 工位分配 | - | - | ✅ | ✅ | - | - |
| 员工管理 | - | - | - | ✅ | ✅ | ✅ |
| 订单管理 | - | - | - | ✅ | ✅ | ✅ |
| 券配置 | - | - | - | - | ✅ | ✅ |
| 统计报表 | - | - | - | ✅ | ✅ | ✅ |
| 系统配置 | - | - | - | - | - | ✅ |

---

## 三、业务流程设计

### 3.1 整体流程图（更新版）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           汽车美容服务流程 v2                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐              │
│  │ 洗车券   │───▶│ 到站排队 │───▶│ 车辆进场 │───▶│ 扫码消券 │              │
│  │ 获取     │    │ 扫码取号 │    │ 抓拍车牌 │    │ 关联车牌 │              │
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘              │
│       │               │               │               │                     │
│       ▼               ▼               ▼               ▼                     │
│  加油赠送/自购   系统/人工调度    海康ISAPI       用户-车牌绑定              │
│                                  员工确认车牌     洗车房锁定                 │
│                                                                             │
│                                      │                                      │
│                                      ▼                                      │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐              │
│  │ 外观检查 │───▶│ 服务进行 │───▶│ 服务完成 │───▶│ 用户取车 │              │
│  │ 拍照上传 │    │ 追加服务 │    │ 订单结算 │    │ 释放工位 │              │
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘              │
│       │               │               │                                     │
│       ▼               ▼               ▼                                     │
│   员工上传照片    打蜡/抛光/换胎   追加项H5支付                               │
│   记录车况       过程拍照上传                                                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 详细步骤（更新版）

| 步骤 | 动作 | 系统行为 | 数据变化 | 责任方 |
|------|------|----------|----------|--------|
| 1 | 用户获取洗车券 | 加油满赠/用户自购 | 创建洗车券记录，绑定用户ID | 系统自动 |
| 2 | 用户到站排队 | 扫码取号 | 创建排队记录 | 用户 |
| 3 | 调度分配工位 | 系统自动/人工分配 | 更新排队状态 | 系统/调度 |
| 4 | 车辆驶入洗车房 | 摄像头抓拍车牌 | 临时记录：工位ID + 车牌号 | 系统自动 |
| 5 | 员工确认车牌 | 校验摄像头结果 | 确认车牌准确性 | 员工 |
| 6 | 用户扫员工码 | 验证洗车券、消券 | **订单级用户-车牌绑定** | 用户 |
| 7 | 外观检查拍照 | 员工上传照片 | 订单关联外观照片 | 员工 |
| 8 | 洗车房锁定 | 工位状态变更 | 工位状态=服务中 | 系统自动 |
| 9 | 服务进行 | 员工操作 | 更新服务项状态 | 员工 |
| 10 | 追加服务 | 员工添加+用户支付 | 新增订单明细，支付记录 | 员工+用户 |
| 11 | 过程拍照 | 员工上传 | 订单关联过程照片 | 员工 |
| 12 | 服务完成 | 员工标记完成 | 订单状态=待取车 | 员工 |
| 13 | 用户取车 | 确认取车 | 订单状态=已完成，释放工位 | 用户 |

### 3.3 工位覆盖规则

```
场景：前车未扫码，新车进入

时序：
1. 车A进入工位 → 抓拍车牌A → 等待扫码
2. 用户A未扫码（可能离开了）
3. 车B进入工位 → 抓拍车牌B → 覆盖车牌A

系统行为：
- 车牌A的临时记录被覆盖
- 如有车牌A的待处理订单 → 状态改为"挂起"
- 车牌B成为当前工位的有效车牌

挂起订单处理：
- 管理后台可查看挂起订单
- 人工决定：作废 / 恢复
```

---

## 四、核心实体设计

### 4.1 数据模型（更新版）

```
┌─────────────┐       ┌─────────────┐       ┌─────────────┐
│   用户      │       │   车牌      │       │   洗车券    │
│   User      │       │   Vehicle   │       │   Coupon    │
├─────────────┤       ├─────────────┤       ├─────────────┤
│ user_id     │◀──┐   │ plate_no    │       │ coupon_id   │
│ phone       │   │   │ user_id     │       │ user_id     │
│ name        │   │   │ bindTime    │       │ type        │
│ openid      │   │   │ source      │       │ source      │
└─────────────┘   │   └─────────────┘       │ status      │
                  │         ▲               │ expire_time │
                  │         │ N:N          │ platform_id │
                  │         │               └─────────────┘
                  └─────────┘
                 一个车牌可被多用户关联
                 订单级别确定实际使用者

┌─────────────┐       ┌─────────────┐       ┌─────────────┐
│   工位      │       │   订单      │       │   订单明细  │
│   Station   │       │   Order     │       │ OrderItem   │
├─────────────┤       ├─────────────┤       ├─────────────┤
│ station_id  │◀──────│ order_id    │──────▶│ item_id     │
│ name        │       │ station_id  │  1:N  │ order_id    │
│ camera_id   │       │ user_id     │       │ service_type│
│ status      │       │ plate_no    │       │ employee_id │
│ site_id     │       │ coupon_id   │       │ status      │
└─────────────┘       │ status      │       │ price       │
                      │ queue_id    │       │ pay_status  │
                      │ create_time │       └─────────────┘
                      │ finish_time │
                      └─────────────┘
                             │
                             │ 1:N
                             ▼
                      ┌─────────────┐
                      │  订单照片   │
                      │ OrderPhoto  │
                      ├─────────────┤
                      │ photo_id    │
                      │ order_id    │
                      │ type        │ ← 外观检查/过程记录
                      │ url         │
                      │ employee_id │
                      │ create_time │
                      └─────────────┘

┌─────────────┐       ┌─────────────┐       ┌─────────────┐
│   员工      │       │   服务类型  │       │   排队      │
│  Employee   │       │ ServiceType │       │   Queue     │
├─────────────┤       ├─────────────┤       ├─────────────┤
│ emp_id      │       │ type_id     │       │ queue_id    │
│ name        │       │ name        │       │ user_id     │
│ site_id     │       │ price       │       │ site_id     │
│ role        │       │ duration    │ ←服务时长│ queue_no    │
│ qr_code     │       │ category    │       │ status      │
└─────────────┘       └─────────────┘       │ create_time │
                                            │ called_time │
                                            └─────────────┘

┌─────────────┐       ┌─────────────┐       ┌─────────────┐
│   配件      │       │ 配件库存    │       │ 订单配件    │
│   Part      │       │ PartStock   │       │ OrderPart   │
├─────────────┤       ├─────────────┤       ├─────────────┤
│ part_id     │◀──────│ stock_id    │       │ id          │
│ name        │       │ part_id     │       │ order_id    │
│ category    │       │ site_id     │       │ part_id     │
│ brand       │       │ quantity    │       │ quantity    │
│ spec        │       │ safety_qty  │       │ price       │
│ unit        │       │ update_time │       │ employee_id │
│ base_price  │       └─────────────┘       └─────────────┘
│ lead_time   │ ←无货时配送天数
└─────────────┘
```

### 4.2 外观检查设计

**问题**：外观确认是做到平台还是纸质？

**分析**：

| 方案 | 优点 | 缺点 |
|------|------|------|
| **平台拍照** | 数据留存、可追溯、防纠纷证据充分 | 需开发、依赖网络 |
| **纸质填写** | 简单、无需开发 | 易丢失、难追溯、纠纷时无证据 |
| **平台+纸质** | 双重保障 | 流程繁琐、员工抵触 |

**建议：平台拍照**

```
外观检查流程：
1. 员工绕车一周，拍摄4-6张照片（前后左右+重点部位）
2. 上传到订单，系统自动打时间水印
3. 用户可在订单详情中查看
4. 纠纷时作为证据

照片类型：
- 外观检查（服务前，必须）
- 过程记录（服务中，至少1张）
- 完成确认（服务后，可选）
```

### 4.3 配件库设计

**场景**：换轮胎、更换雨刮等服务需要使用配件

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           配件服务流程                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐          │
│  │ 追加服务 │───▶│ 选择配件 │───▶│ 库存检查 │───▶│ 确认下单 │          │
│  │ (换胎)   │    │ 品牌/规格│    │          │    │          │          │
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘          │
│                                       │                                 │
│                          ┌────────────┼────────────┐                   │
│                          ▼            ▼            ▼                   │
│                     有现货        库存不足      无现货                  │
│                    立即服务      显示剩余数    显示配送时间              │
│                                  可部分服务    用户决定等/换             │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**配件数据结构**：

| 字段 | 说明 | 示例 |
|------|------|------|
| name | 配件名称 | 轮胎 |
| category | 配件分类 | 轮胎/雨刮/机油/滤芯 |
| brand | 品牌 | 米其林/普利司通 |
| spec | 规格型号 | 225/45R17 |
| unit | 单位 | 条/个/升 |
| base_price | 基础售价 | ¥800 |
| lead_time | 无货配送时间(天) | 3 |

**库存管理**：

| 功能 | 说明 |
|------|------|
| 实时库存 | 每个站点独立库存 |
| 安全库存 | 低于阈值提醒补货 |
| 库存流水 | 入库/出库/盘点记录 |
| 配送时间 | 无货时显示预计到货天数 |

**员工操作流程**：
```
1. 追加"换轮胎"服务
2. 选择轮胎品牌、规格
3. 系统检查库存：
   ┌─────────────────────────────────────────────────────────────┐
   │                     库存状态判断                             │
   ├─────────────────────────────────────────────────────────────┤
   │                                                             │
   │  有现货 ───────▶ 立即服务，库存扣减                          │
   │                                                             │
   │  无现货 ───┬───▶ 马上到货（当天可到）                        │
   │            │     └─ 用户等待，配件到后继续服务               │
   │            │                                                 │
   │            └───▶ 预约到货（需采购，N天后到）                  │
   │                  └─ 记入用户"待处理清单"                     │
   │                  └─ 配件到货后通知用户                       │
   │                  └─ 用户下次来店时处理                       │
   │                                                             │
   └─────────────────────────────────────────────────────────────┘
4. 确认后，有货配件库存自动扣减
5. 配件费用计入订单
```

**用户待处理清单**：
```
┌─────────────────────────────────────────────────────────────┐
│                     我的待处理配件                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 米其林轮胎 225/45R17                                 │   │
│  │ 预计到货：2026-01-22                                 │   │
│  │ 状态：采购中                                         │   │
│  │ [到货通知我]                                         │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 博世雨刮片 24寸                                      │   │
│  │ 预计到货：2026-01-21                                 │   │
│  │ 状态：已到货 ✅                                      │   │
│  │ [预约安装]                                           │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**待处理清单数据模型**：
```
┌─────────────────┐
│ UserPartOrder   │  用户配件预约单
├─────────────────┤
│ id              │
│ user_id         │
│ part_id         │
│ quantity        │
│ site_id         │
│ status          │ ← 采购中/已到货/已完成/已取消
│ expect_date     │ ← 预计到货日期
│ arrive_date     │ ← 实际到货日期
│ order_id        │ ← 关联的服务订单（完成时）
│ create_time     │
└─────────────────┘
```

### 4.5 追加服务确认机制

**规则**：追加服务可由用户或员工发起，但**最终都需要用户确认**才能生效。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        追加服务流程                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  发起方式：                                                              │
│  ┌────────────────┐        ┌────────────────┐                          │
│  │  用户自主追加   │        │  员工帮用户追加 │                          │
│  │  (H5操作)      │        │  (APP操作)     │                          │
│  └───────┬────────┘        └───────┬────────┘                          │
│          │                         │                                    │
│          │                         ▼                                    │
│          │              ┌─────────────────────┐                        │
│          │              │ 检查服务配置开关     │                        │
│          │              │ "允许员工代操作"    │                        │
│          │              └──────────┬──────────┘                        │
│          │                   开启 │ 关闭                               │
│          │                    ▼   │   ▼                                │
│          │               可追加   │  禁止                              │
│          │                   │    │                                    │
│          ▼                   ▼    │                                    │
│  ┌───────────────────────────────┐│                                    │
│  │        用户确认环节           ││                                    │
│  │  - 显示追加项目和价格         ││                                    │
│  │  - 用户在H5点击"确认"        ││                                    │
│  │  - 确认后进入待支付状态       ││                                    │
│  └───────────────────────────────┘│                                    │
│                 │                 │                                    │
│                 ▼                 │                                    │
│  ┌───────────────────────────────┐│                                    │
│  │        H5支付                 ││                                    │
│  │  - 微信支付                   ││                                    │
│  │  - 支付成功后服务项生效       ││                                    │
│  └───────────────────────────────┘│                                    │
│                                   │                                    │
└─────────────────────────────────────────────────────────────────────────┘
```

**服务配置开关**：

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| allow_employee_add | 允许员工帮用户追加服务 | 开启 |
| require_user_confirm | 追加服务需用户确认 | 开启（强制） |

**用户确认界面**：
```
┌─────────────────────────────┐
│  员工为您推荐了追加服务      │
├─────────────────────────────┤
│                             │
│  🔧 打蜡服务        ¥150    │
│  🔧 内饰清洁        ¥80     │
│                             │
│  ───────────────────────    │
│  合计              ¥230     │
│                             │
│  [拒绝]      [确认并支付]   │
│                             │
└─────────────────────────────┘
```

### 4.6 状态流转（更新版）

**排队状态：**
```
排队中 ──▶ 已叫号 ──▶ 已进场 ──▶ 已完成
                         │
                         └──▶ 已过号（超时未响应）
```

**工位状态：**
```
空闲 ──▶ 车辆进入（抓拍） ──▶ 服务中（扫码确认） ──▶ 待取车 ──▶ 空闲
              │
              └──▶ 被覆盖（新车进入，前车未扫码）
```

**订单状态：**
```
待确认 ──▶ 外观检查 ──▶ 服务中 ──▶ 待取车 ──▶ 已完成
              │            │
              │            └──▶ 追加服务待支付
              │
              └──▶ 挂起（被新车覆盖）──▶ 作废/恢复
```

---

## 五、排队与调度设计

### 5.1 排队模式

```
用户到站 ──▶ 扫码取号 ──▶ 进入队列 ──▶ 等待叫号 ──▶ 进入工位

取号方式：
- 站点入口放置排队二维码
- 用户扫码 → H5页面 → 取号
- 显示：排队号码、前面人数、预计等待时间
```

### 5.2 容量计算（核心逻辑）

**原则**：车到现场排队，当天应该都能处理完。需要计算当天剩余可服务容量。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           每日容量计算                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  配置项：                                                                │
│  ├─ 营业时间：09:00 - 18:00（9小时 = 540分钟）                           │
│  ├─ 工位数量：4个                                                        │
│  ├─ 每个服务的标准时长：                                                 │
│  │   └─ 洗车：30分钟                                                     │
│  │   └─ 打蜡：45分钟                                                     │
│  │   └─ 抛光：60分钟                                                     │
│  │   └─ 换胎：40分钟                                                     │
│                                                                         │
│  计算公式：                                                              │
│  ├─ 总可用时间 = 营业时长 × 工位数 = 540 × 4 = 2160分钟                  │
│  ├─ 已占用时间 = Σ(已排队订单 × 服务时长)                                │
│  ├─ 剩余可用时间 = 总可用时间 - 已占用时间                               │
│  └─ 可接单数(按洗车算) = 剩余可用时间 ÷ 30                              │
│                                                                         │
│  示例：                                                                  │
│  ├─ 当前已排队：20单洗车(600分钟) + 5单打蜡(225分钟) = 825分钟           │
│  ├─ 剩余可用：2160 - 825 = 1335分钟                                     │
│  └─ 还能接约 44 单洗车，或 29 单打蜡                                    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**用户取号时显示**：
```
┌─────────────────────────────┐
│  当前排队：第 25 位          │
│  预计等待：约 45 分钟        │
│  今日剩余容量：充足 ✅       │
│                             │
│  [确认取号]                 │
└─────────────────────────────┘
```

**容量不足时**：
```
┌─────────────────────────────┐
│  ⚠️ 今日排队已满             │
│  预计最早可服务：明日 09:00  │
│                             │
│  [预约明日] [取消]          │
└─────────────────────────────┘
```

### 5.3 调度策略

| 模式 | 说明 | 适用场景 |
|------|------|----------|
| **自动调度** | 系统按取号顺序，工位空闲自动叫号 | 标准化服务、工位无差异 |
| **人工调度** | 调度员手动分配用户到工位 | 服务差异大、VIP优先 |
| **混合模式** | 默认自动，支持人工干预 | 推荐 |

### 5.4 排队规则

```
1. 先到先服务（FIFO）
2. 现场排队，当天处理（无过号机制）
3. 容量计算基于服务时长配置
4. 支持VIP插队（人工操作）
5. 显示预计等待时间 = 前面人数 × 平均服务时长
```

---

## 六、统计报表设计

### 6.1 员工绩效面板

**绩效统计规则**：按员工 × 服务类型 × 次数 统计

```
┌─────────────────────────────────────────────────────────────┐
│                      员工绩效统计                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  时间范围：[今日] [本周] [本月] [自定义]                      │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  员工     │ 洗车 │ 打蜡 │ 抛光 │ 换胎 │ 合计  │      │   │
│  │───────────┼──────┼──────┼──────┼──────┼───────┼──────│   │
│  │  张三     │  15  │   5  │   3  │   2  │  25   │      │   │
│  │  李四     │  12  │   6  │   2  │   2  │  22   │      │   │
│  │  王五     │  10  │   4  │   2  │   2  │  18   │      │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  服务类型明细（点击员工展开）：                               │
│  ├─ 洗车服务：XX 次                                          │
│  ├─ 打蜡服务：XX 次                                          │
│  ├─ 抛光服务：XX 次                                          │
│  └─ 换胎服务：XX 次                                          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 服务统计面板

```
┌─────────────────────────────────────────────────────────────┐
│                      美容服务统计                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐   │
│  │   今日订单     │  │   今日收入     │  │   平均时长     │   │
│  │      58       │  │   ¥12,500    │  │    35分钟     │   │
│  │   ↑12% vs昨日 │  │   ↑8% vs昨日  │  │   ↓5% vs昨日  │   │
│  └───────────────┘  └───────────────┘  └───────────────┘   │
│                                                             │
│  服务类型分布：                  工位利用率：                  │
│  ┌─────────────────┐          ┌─────────────────┐          │
│  │ 洗车    ████ 65%│          │ 1号位   ███ 78% │          │
│  │ 打蜡    ██  20% │          │ 2号位   ████ 85%│          │
│  │ 抛光    █   10% │          │ 3号位   ██  65% │          │
│  │ 换胎    ▌    5% │          │ 4号位   ███ 72% │          │
│  └─────────────────┘          └─────────────────┘          │
│                                                             │
│  趋势图：（近7日订单量/收入走势）                             │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.3 核心指标

| 维度 | 指标 | 说明 |
|------|------|------|
| **订单** | 订单总数、完成率、取消率 | 按日/周/月统计 |
| **收入** | 总收入、券核销金额、追加服务收入 | 区分收入来源 |
| **效率** | 平均服务时长、工位周转率 | 运营效率 |
| **员工** | 人均服务单数、追加销售额、好评率 | 绩效考核 |
| **券** | 发放量、核销量、过期量 | 券运营效果 |

---

## 七、技术方案

### 7.1 技术栈

| 层级 | 技术 | 说明 |
|------|------|------|
| 后端 | Java + Spring Boot | 现有系统技术栈，直接扩展 |
| 前端（管理后台） | Vue2 | 现有系统技术栈 |
| 前端（用户H5） | Vue2 H5 | 嵌入微信公众号 |
| 前端（员工APP） | 待定 | 可考虑 uni-app / 原生 |
| 消息推送 | 微信公众号模板消息 | 配件到货通知、服务完成通知 |

### 7.2 海康摄像头对接

**设备型号**：DS-2CD3646WDV3-LZ

```
┌────────────┐     HTTP/ISAPI     ┌────────────┐
│  海康摄像头 │ ──────────────────▶ │  业务系统   │
│DS-2CD3646  │   车牌识别事件推送   │ SpringBoot │
└────────────┘                    └────────────┘

对接方式：
1. 订阅模式：摄像头主动推送识别事件（推荐）
2. 轮询模式：系统定时拉取识别结果

关键接口：
- /ISAPI/Traffic/channels/<ID>/vehicleDetect  # 车辆检测配置
- /ISAPI/Event/notification/alertStream       # 事件订阅
```

**DS-2CD3646WDV3-LZ 特性**：
- 支持车牌识别（ANPR）
- 支持 ISAPI 协议
- 支持事件订阅推送
- 适用于室内/半室外环境（洗车房适用）

### 7.3 消息通知方案

**通知渠道**：微信公众号模板消息

| 通知场景 | 触发时机 | 模板内容 |
|----------|----------|----------|
| 配件到货 | 预约配件入库时 | "您预约的XX配件已到货，请到店安装" |
| 服务完成 | 员工标记完成时 | "您的爱车已服务完成，请及时取车" |
| 排队叫号 | 叫号时 | "轮到您了，请驶入X号工位" |
| 追加确认 | 员工发起追加时 | "员工为您推荐了XX服务，请确认" |

**实现方式**：
```java
// Spring Boot 调用微信模板消息 API
@Service
public class WxMsgService {
    
    public void sendPartArriveNotice(String openId, String partName, String siteName) {
        // 调用微信公众号模板消息接口
        // POST https://api.weixin.qq.com/cgi-bin/message/template/send
    }
}
```

### 7.4 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                        前端层                                │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐   │
│  │ 用户H5        │  │ 员工APP       │  │ 管理后台      │   │
│  │ - 扫码消券    │  │ - 收券码      │  │ - 工位管理    │   │
│  │ - 排队取号    │  │ - 车牌确认    │  │ - 订单管理    │   │
│  │ - 追加支付    │  │ - 拍照上传    │  │ - 统计报表    │   │
│  │ - 订单查看    │  │ - 服务操作    │  │ - 员工绩效    │   │
│  └───────────────┘  └───────────────┘  └───────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        服务层                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              加油站管理平台（现有）                    │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐              │   │
│  │  │用户模块 │  │订单模块 │  │支付模块 │  ...         │   │
│  │  └─────────┘  └─────────┘  └─────────┘              │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │              汽车美容扩展（新增）                      │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌────────┐ │   │
│  │  │洗车券   │  │工位管理 │  │美容订单 │  │摄像头  │ │   │
│  │  │服务     │  │服务     │  │服务     │  │对接    │ │   │
│  │  ├─────────┤  ├─────────┤  ├─────────┤  ├────────┤ │   │
│  │  │排队     │  │调度     │  │绩效     │  │照片    │ │   │
│  │  │服务     │  │服务     │  │统计     │  │服务    │ │   │
│  │  └─────────┘  └─────────┘  └─────────┘  └────────┘ │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

---

## 八、待确认事项（更新）

### 🔴 已确认

| # | 问题 | 确认结果 |
|---|------|----------|
| 1 | 车牌能否多用户绑定？ | ✅ 可以，订单级别确定实际用户 |
| 2 | 摄像头识别失败怎么办？ | ✅ 员工确认+手动输入 |
| 3 | 前车未扫码新车进入？ | ✅ 覆盖前车，前车订单挂起/作废 |
| 4 | 追加服务如何支付？ | ✅ H5现场直接支付 |
| 5 | 预约功能怎么做？ | ✅ 到站扫码排队，系统/人工调度 |
| 6 | 需要员工绩效？ | ✅ 需要，按员工×服务类型×次数统计 |
| 7 | 券有效期和转赠？ | ✅ 平台设置有效期，暂不支持转赠 |
| 8 | 服务过程需要拍照？ | ✅ 需要，员工上传过程照片 |
| 9 | 外观检查拍几张？ | ✅ 4-6张（前后左右+损伤特写） |
| 10 | 排队过号规则？ | ✅ 无过号，现场排队当天处理，按服务时长计算容量 |
| 11 | 涉及配件的服务？ | ✅ 需要配件库，有货显示库存，无货显示配送时间 |
| 12 | 配件库存由谁维护？ | ✅ 系统有对应角色授权（现有权限体系） |
| 13 | 无货配件处理方式？ | ✅ 马上到货→等待处理；预约到货→记入用户待处理清单，下次处理 |
| 14 | 追加服务确认流程？ | ✅ 用户或员工可发起，最终都需用户确认；员工是否可操作由服务配置开关控制 |
| 15 | 现有系统技术栈？ | ✅ Java Spring Boot + Vue2 |
| 16 | 海康摄像头型号？ | ✅ DS-2CD3646WDV3-LZ，支持ISAPI |
| 17 | 是否需要服务评价？ | ✅ 当前不需要 |
| 18 | 配件到货通知方式？ | ✅ 微信公众号模板消息 |

### 🟢 全部确认完成

所有关键问题已确认，可进入开发阶段。

---

## 九、MVP范围建议

### 第一期（核心流程）

| 功能 | 优先级 | 说明 |
|------|--------|------|
| 用户扫码消券 | P0 | 核心消费流程 |
| 摄像头车牌识别 | P0 | 车牌关联基础 |
| 员工收券+确认车牌 | P0 | 员工操作入口 |
| 外观检查拍照 | P0 | 服务前必须（4-6张） |
| 追加服务+支付 | P0 | 增值收入 |
| 配件库+库存管理 | P0 | 换胎等服务必须 |
| 订单管理 | P0 | 基础管理 |
| 工位状态管理 | P0 | 运营必须 |

### 第二期（效率提升）

| 功能 | 优先级 | 说明 |
|------|--------|------|
| 排队取号 | P1 | 用户体验 |
| 调度分配 | P1 | 运营效率 |
| 员工绩效统计 | P1 | 管理需求 |
| 服务统计面板 | P1 | 数据分析 |

### 第三期（体验优化）

| 功能 | 优先级 | 说明 |
|------|--------|------|
| 服务评价 | P2 | 用户反馈 |
| 预约功能 | P2 | 高级排队 |
| 工位大屏 | P2 | 现场展示 |

---

---

## 十、数据库设计（DDL）

基于第四章实体模型，输出 MySQL DDL。

### 10.1 用户与车牌

```sql
-- 用户表（扩展现有用户表，仅列出新增字段）
-- 假设现有 t_user 表已有 user_id, phone, name, openid 等字段

-- 车牌表
CREATE TABLE t_vehicle (
    id              BIGINT          PRIMARY KEY AUTO_INCREMENT,
    plate_no        VARCHAR(20)     NOT NULL COMMENT '车牌号',
    user_id         BIGINT          NOT NULL COMMENT '绑定用户ID',
    bind_time       DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '绑定时间',
    source          VARCHAR(20)     NOT NULL DEFAULT 'SCAN' COMMENT '绑定来源: SCAN-扫码绑定, MANUAL-手动添加',
    is_deleted      TINYINT         NOT NULL DEFAULT 0,
    create_time     DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time     DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id),
    INDEX idx_plate_no (plate_no)
) COMMENT '用户车牌表（多对多，一个车牌可被多用户绑定）';
```

### 10.2 洗车券

```sql
-- 洗车券表
CREATE TABLE t_coupon (
    id              BIGINT          PRIMARY KEY AUTO_INCREMENT,
    coupon_no       VARCHAR(32)     NOT NULL UNIQUE COMMENT '券编号',
    user_id         BIGINT          NOT NULL COMMENT '持有用户ID',
    type            VARCHAR(20)     NOT NULL COMMENT '券类型: WASH-洗车券, WAX-打蜡券, COMBO-组合券',
    source          VARCHAR(20)     NOT NULL COMMENT '来源: PURCHASE-购买, GIFT-加油满赠, ACTIVITY-活动',
    status          VARCHAR(20)     NOT NULL DEFAULT 'VALID' COMMENT '状态: VALID-有效, USED-已使用, EXPIRED-已过期',
    expire_time     DATETIME        NOT NULL COMMENT '过期时间',
    use_time        DATETIME        NULL COMMENT '使用时间',
    order_id        BIGINT          NULL COMMENT '使用时关联的订单ID',
    site_id         BIGINT          NOT NULL COMMENT '适用站点ID（0表示通用）',
    create_time     DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time     DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id),
    INDEX idx_status_expire (status, expire_time)
) COMMENT '洗车券表';
```

### 10.3 站点与工位

```sql
-- 站点表（扩展现有站点表）
-- 假设现有 t_site 表已有基础信息

-- 工位表
CREATE TABLE t_station (
    id              BIGINT          PRIMARY KEY AUTO_INCREMENT,
    site_id         BIGINT          NOT NULL COMMENT '所属站点ID',
    name            VARCHAR(50)     NOT NULL COMMENT '工位名称（如：1号位）',
    camera_id       VARCHAR(100)    NULL COMMENT '绑定摄像头ID',
    camera_ip       VARCHAR(50)     NULL COMMENT '摄像头IP地址',
    status          VARCHAR(20)     NOT NULL DEFAULT 'IDLE' COMMENT '状态: IDLE-空闲, OCCUPIED-有车, SERVING-服务中, WAITING-待取车',
    current_plate   VARCHAR(20)     NULL COMMENT '当前工位车牌（摄像头识别）',
    current_order_id BIGINT         NULL COMMENT '当前服务订单ID',
    is_enabled      TINYINT         NOT NULL DEFAULT 1 COMMENT '是否启用',
    create_time     DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time     DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_site_id (site_id)
) COMMENT '洗车工位表';
```

### 10.4 员工

```sql
-- 员工表（洗车业务扩展）
CREATE TABLE t_wash_employee (
    id              BIGINT          PRIMARY KEY AUTO_INCREMENT,
    emp_no          VARCHAR(32)     NOT NULL UNIQUE COMMENT '员工编号',
    name            VARCHAR(50)     NOT NULL COMMENT '姓名',
    phone           VARCHAR(20)     NOT NULL COMMENT '手机号',
    site_id         BIGINT          NOT NULL COMMENT '所属站点ID',
    role            VARCHAR(20)     NOT NULL COMMENT '角色: WASHER-洗车员, DISPATCHER-调度员, MANAGER-站长',
    qr_code         VARCHAR(200)    NULL COMMENT '个人收券码URL',
    status          VARCHAR(20)     NOT NULL DEFAULT 'ACTIVE' COMMENT '状态: ACTIVE-在职, INACTIVE-离职',
    create_time     DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time     DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_site_id (site_id)
) COMMENT '洗车员工表';
```

### 10.5 服务类型

```sql
-- 服务类型表
CREATE TABLE t_service_type (
    id              BIGINT          PRIMARY KEY AUTO_INCREMENT,
    code            VARCHAR(32)     NOT NULL UNIQUE COMMENT '服务编码',
    name            VARCHAR(50)     NOT NULL COMMENT '服务名称',
    category        VARCHAR(20)     NOT NULL COMMENT '分类: WASH-清洗, BEAUTY-美容, REPAIR-维修',
    price           DECIMAL(10,2)   NOT NULL COMMENT '标准价格',
    duration        INT             NOT NULL COMMENT '标准时长（分钟）',
    need_part       TINYINT         NOT NULL DEFAULT 0 COMMENT '是否需要配件',
    allow_emp_add   TINYINT         NOT NULL DEFAULT 1 COMMENT '允许员工代客追加',
    sort_order      INT             NOT NULL DEFAULT 0 COMMENT '排序',
    is_enabled      TINYINT         NOT NULL DEFAULT 1,
    create_time     DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time     DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) COMMENT '服务类型配置表';
```

### 10.6 排队

```sql
-- 排队表
CREATE TABLE t_queue (
    id              BIGINT          PRIMARY KEY AUTO_INCREMENT,
    queue_no        VARCHAR(20)     NOT NULL COMMENT '排队号（如：A001）',
    user_id         BIGINT          NOT NULL COMMENT '用户ID',
    site_id         BIGINT          NOT NULL COMMENT '站点ID',
    status          VARCHAR(20)     NOT NULL DEFAULT 'WAITING' COMMENT '状态: WAITING-排队中, CALLED-已叫号, ENTERED-已进场, COMPLETED-已完成, EXPIRED-已过号',
    queue_date      DATE            NOT NULL COMMENT '排队日期',
    create_time     DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '取号时间',
    called_time     DATETIME        NULL COMMENT '叫号时间',
    entered_time    DATETIME        NULL COMMENT '进场时间',
    station_id      BIGINT          NULL COMMENT '分配工位ID',
    INDEX idx_site_date (site_id, queue_date),
    INDEX idx_user_id (user_id)
) COMMENT '排队表';
```

### 10.7 订单

```sql
-- 美容订单主表
CREATE TABLE t_wash_order (
    id              BIGINT          PRIMARY KEY AUTO_INCREMENT,
    order_no        VARCHAR(32)     NOT NULL UNIQUE COMMENT '订单编号',
    site_id         BIGINT          NOT NULL COMMENT '站点ID',
    station_id      BIGINT          NOT NULL COMMENT '工位ID',
    user_id         BIGINT          NOT NULL COMMENT '用户ID',
    plate_no        VARCHAR(20)     NOT NULL COMMENT '服务车牌',
    coupon_id       BIGINT          NULL COMMENT '使用的洗车券ID',
    queue_id        BIGINT          NULL COMMENT '关联排队ID',
    status          VARCHAR(20)     NOT NULL DEFAULT 'PENDING' COMMENT '状态: PENDING-待确认, CHECKING-外观检查, SERVING-服务中, WAITING_PAY-待支付, WAITING_PICKUP-待取车, COMPLETED-已完成, SUSPENDED-挂起, CANCELLED-已取消',
    total_amount    DECIMAL(10,2)   NOT NULL DEFAULT 0 COMMENT '订单总金额',
    coupon_amount   DECIMAL(10,2)   NOT NULL DEFAULT 0 COMMENT '券抵扣金额',
    pay_amount      DECIMAL(10,2)   NOT NULL DEFAULT 0 COMMENT '实付金额',
    pay_status      VARCHAR(20)     NOT NULL DEFAULT 'UNPAID' COMMENT '支付状态: UNPAID-未支付, PARTIAL-部分支付, PAID-已支付',
    create_time     DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,
    check_time      DATETIME        NULL COMMENT '外观检查时间',
    start_time      DATETIME        NULL COMMENT '服务开始时间',
    finish_time     DATETIME        NULL COMMENT '服务完成时间',
    pickup_time     DATETIME        NULL COMMENT '取车时间',
    update_time     DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id),
    INDEX idx_site_id (site_id),
    INDEX idx_plate_no (plate_no),
    INDEX idx_status (status)
) COMMENT '美容订单主表';

-- 订单明细表
CREATE TABLE t_wash_order_item (
    id              BIGINT          PRIMARY KEY AUTO_INCREMENT,
    order_id        BIGINT          NOT NULL COMMENT '订单ID',
    service_type_id BIGINT          NOT NULL COMMENT '服务类型ID',
    service_name    VARCHAR(50)     NOT NULL COMMENT '服务名称（冗余）',
    employee_id     BIGINT          NULL COMMENT '服务员工ID',
    price           DECIMAL(10,2)   NOT NULL COMMENT '服务价格',
    status          VARCHAR(20)     NOT NULL DEFAULT 'PENDING' COMMENT '状态: PENDING-待开始, DOING-进行中, DONE-已完成',
    is_addon        TINYINT         NOT NULL DEFAULT 0 COMMENT '是否追加服务',
    pay_status      VARCHAR(20)     NOT NULL DEFAULT 'UNPAID' COMMENT '支付状态',
    start_time      DATETIME        NULL,
    finish_time     DATETIME        NULL,
    create_time     DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_order_id (order_id)
) COMMENT '订单服务明细表';

-- 订单照片表
CREATE TABLE t_wash_order_photo (
    id              BIGINT          PRIMARY KEY AUTO_INCREMENT,
    order_id        BIGINT          NOT NULL COMMENT '订单ID',
    type            VARCHAR(20)     NOT NULL COMMENT '类型: CHECK-外观检查, PROCESS-过程记录, COMPLETE-完成确认',
    url             VARCHAR(500)    NOT NULL COMMENT '照片URL',
    employee_id     BIGINT          NOT NULL COMMENT '上传员工ID',
    remark          VARCHAR(200)    NULL COMMENT '备注',
    create_time     DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_order_id (order_id)
) COMMENT '订单照片表';
```

### 10.8 配件库存

```sql
-- 配件表
CREATE TABLE t_part (
    id              BIGINT          PRIMARY KEY AUTO_INCREMENT,
    code            VARCHAR(32)     NOT NULL UNIQUE COMMENT '配件编码',
    name            VARCHAR(100)    NOT NULL COMMENT '配件名称',
    category        VARCHAR(20)     NOT NULL COMMENT '分类: TIRE-轮胎, WIPER-雨刮, OIL-机油, FILTER-滤芯, OTHER-其他',
    brand           VARCHAR(50)     NULL COMMENT '品牌',
    spec            VARCHAR(100)    NULL COMMENT '规格型号',
    unit            VARCHAR(10)     NOT NULL COMMENT '单位: 条/个/升',
    base_price      DECIMAL(10,2)   NOT NULL COMMENT '基础售价',
    lead_time       INT             NOT NULL DEFAULT 3 COMMENT '无货配送时间（天）',
    is_enabled      TINYINT         NOT NULL DEFAULT 1,
    create_time     DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time     DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) COMMENT '配件表';

-- 配件库存表（每站点独立库存）
CREATE TABLE t_part_stock (
    id              BIGINT          PRIMARY KEY AUTO_INCREMENT,
    part_id         BIGINT          NOT NULL COMMENT '配件ID',
    site_id         BIGINT          NOT NULL COMMENT '站点ID',
    quantity        INT             NOT NULL DEFAULT 0 COMMENT '当前库存',
    safety_qty      INT             NOT NULL DEFAULT 5 COMMENT '安全库存（低于此值预警）',
    update_time     DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_part_site (part_id, site_id)
) COMMENT '配件库存表';

-- 库存流水表
CREATE TABLE t_part_stock_log (
    id              BIGINT          PRIMARY KEY AUTO_INCREMENT,
    part_id         BIGINT          NOT NULL,
    site_id         BIGINT          NOT NULL,
    type            VARCHAR(20)     NOT NULL COMMENT '类型: IN-入库, OUT-出库, CHECK-盘点',
    quantity        INT             NOT NULL COMMENT '变动数量（正负）',
    before_qty      INT             NOT NULL COMMENT '变动前数量',
    after_qty       INT             NOT NULL COMMENT '变动后数量',
    order_id        BIGINT          NULL COMMENT '关联订单ID（出库时）',
    operator_id     BIGINT          NOT NULL COMMENT '操作人ID',
    remark          VARCHAR(200)    NULL,
    create_time     DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_part_site (part_id, site_id)
) COMMENT '库存流水表';

-- 订单配件表
CREATE TABLE t_wash_order_part (
    id              BIGINT          PRIMARY KEY AUTO_INCREMENT,
    order_id        BIGINT          NOT NULL COMMENT '订单ID',
    part_id         BIGINT          NOT NULL COMMENT '配件ID',
    part_name       VARCHAR(100)    NOT NULL COMMENT '配件名称（冗余）',
    quantity        INT             NOT NULL COMMENT '使用数量',
    price           DECIMAL(10,2)   NOT NULL COMMENT '单价',
    total_price     DECIMAL(10,2)   NOT NULL COMMENT '总价',
    employee_id     BIGINT          NOT NULL COMMENT '操作员工ID',
    create_time     DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_order_id (order_id)
) COMMENT '订单配件使用表';

-- 用户配件预约单（无货时）
CREATE TABLE t_user_part_order (
    id              BIGINT          PRIMARY KEY AUTO_INCREMENT,
    user_id         BIGINT          NOT NULL COMMENT '用户ID',
    part_id         BIGINT          NOT NULL COMMENT '配件ID',
    part_name       VARCHAR(100)    NOT NULL COMMENT '配件名称（冗余）',
    quantity        INT             NOT NULL COMMENT '预约数量',
    site_id         BIGINT          NOT NULL COMMENT '站点ID',
    status          VARCHAR(20)     NOT NULL DEFAULT 'ORDERING' COMMENT '状态: ORDERING-采购中, ARRIVED-已到货, COMPLETED-已完成, CANCELLED-已取消',
    expect_date     DATE            NOT NULL COMMENT '预计到货日期',
    arrive_date     DATE            NULL COMMENT '实际到货日期',
    order_id        BIGINT          NULL COMMENT '关联服务订单ID（完成时）',
    notify_status   VARCHAR(20)     NOT NULL DEFAULT 'PENDING' COMMENT '通知状态: PENDING-待通知, SENT-已通知',
    create_time     DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time     DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id),
    INDEX idx_status (status)
) COMMENT '用户配件预约单';
```

---

## 十一、接口设计

### 11.1 用户端 API（微信H5/小程序）

#### 11.1.1 券相关

| 方法 | 接口 | 说明 |
|------|------|------|
| GET | `/api/user/coupons` | 获取我的洗车券列表 |
| GET | `/api/user/coupons/{id}` | 获取券详情 |

```json
// GET /api/user/coupons
// Response
{
  "code": 0,
  "data": {
    "valid": [
      { "id": 1, "couponNo": "C202601190001", "type": "WASH", "typeName": "洗车券", "expireTime": "2026-02-19", "source": "GIFT" }
    ],
    "used": [...],
    "expired": [...]
  }
}
```

#### 11.1.2 扫码消券

| 方法 | 接口 | 说明 |
|------|------|------|
| POST | `/api/user/scan/use-coupon` | 扫员工码消券 |

```json
// POST /api/user/scan/use-coupon
// Request
{
  "empQrCode": "EMP_QR_xxxxx",     // 员工二维码内容
  "couponId": 123,                 // 选择的券ID
  "plateNo": "粤B12345"            // 确认的车牌
}
// Response
{
  "code": 0,
  "data": {
    "orderId": 10001,
    "orderNo": "WO202601190001",
    "stationName": "1号位",
    "status": "CHECKING"
  }
}
```

#### 11.1.3 排队

| 方法 | 接口 | 说明 |
|------|------|------|
| POST | `/api/user/queue/take` | 扫码取号 |
| GET | `/api/user/queue/status` | 查询排队状态 |
| DELETE | `/api/user/queue/{id}` | 取消排队 |

```json
// POST /api/user/queue/take
// Request
{ "siteId": 1 }
// Response
{
  "code": 0,
  "data": {
    "queueId": 100,
    "queueNo": "A015",
    "position": 5,           // 前面还有5人
    "estimateWait": 25       // 预计等待25分钟
  }
}
```

#### 11.1.4 订单

| 方法 | 接口 | 说明 |
|------|------|------|
| GET | `/api/user/orders` | 订单列表 |
| GET | `/api/user/orders/{id}` | 订单详情（含照片、服务项） |
| POST | `/api/user/orders/{id}/confirm-addon` | 确认追加服务 |
| POST | `/api/user/orders/{id}/pay` | 支付追加服务 |

#### 11.1.5 车辆

| 方法 | 接口 | 说明 |
|------|------|------|
| GET | `/api/user/vehicles` | 我的车辆列表 |
| GET | `/api/user/vehicles/{plateNo}/history` | 车辆服务历史 |

#### 11.1.6 配件预约

| 方法 | 接口 | 说明 |
|------|------|------|
| GET | `/api/user/part-orders` | 待处理配件列表 |
| POST | `/api/user/part-orders/{id}/book` | 预约安装 |

---

### 11.2 员工端 API（APP）

#### 11.2.1 收券

| 方法 | 接口 | 说明 |
|------|------|------|
| GET | `/api/emp/qrcode` | 获取我的收券二维码 |
| GET | `/api/emp/station/current-plate` | 获取当前工位摄像头识别的车牌 |
| POST | `/api/emp/station/confirm-plate` | 确认/修正车牌 |

```json
// GET /api/emp/station/current-plate
// Response
{
  "code": 0,
  "data": {
    "stationId": 1,
    "stationName": "1号位",
    "plateNo": "粤B12345",
    "confidence": 0.95,
    "captureTime": "2026-01-19 14:30:00",
    "imageUrl": "https://..."
  }
}
```

#### 11.2.2 订单操作

| 方法 | 接口 | 说明 |
|------|------|------|
| GET | `/api/emp/orders/current` | 当前服务中订单 |
| POST | `/api/emp/orders/{id}/photos` | 上传照片（外观检查/过程） |
| POST | `/api/emp/orders/{id}/start-check` | 开始外观检查 |
| POST | `/api/emp/orders/{id}/start-service` | 开始服务 |
| POST | `/api/emp/orders/{id}/complete` | 服务完成 |

#### 11.2.3 追加服务

| 方法 | 接口 | 说明 |
|------|------|------|
| GET | `/api/emp/service-types` | 可追加服务列表 |
| POST | `/api/emp/orders/{id}/addon` | 添加追加服务 |
| GET | `/api/emp/parts?keyword=` | 搜索配件 |
| GET | `/api/emp/parts/{id}/stock` | 查询配件库存 |
| POST | `/api/emp/orders/{id}/add-part` | 添加配件 |

```json
// POST /api/emp/orders/{id}/addon
// Request
{
  "serviceTypeId": 2,
  "remark": "客户要求打蜡"
}
// Response
{
  "code": 0,
  "data": {
    "addonId": 50,
    "needUserConfirm": true,  // 需要用户确认
    "pushStatus": "SENT"      // 已推送用户
  }
}
```

#### 11.2.4 绩效

| 方法 | 接口 | 说明 |
|------|------|------|
| GET | `/api/emp/performance/today` | 今日绩效 |
| GET | `/api/emp/performance/month` | 本月绩效 |

---

### 11.3 管理后台 API（PC）

#### 11.3.1 工位管理

| 方法 | 接口 | 说明 |
|------|------|------|
| GET | `/api/admin/stations` | 工位列表 |
| PUT | `/api/admin/stations/{id}` | 更新工位配置 |
| GET | `/api/admin/stations/realtime` | 实时工位状态 |

#### 11.3.2 订单管理

| 方法 | 接口 | 说明 |
|------|------|------|
| GET | `/api/admin/orders` | 订单列表（分页、筛选） |
| GET | `/api/admin/orders/{id}` | 订单详情 |
| POST | `/api/admin/orders/{id}/cancel` | 取消订单 |
| POST | `/api/admin/orders/{id}/resume` | 恢复挂起订单 |

#### 11.3.3 券管理

| 方法 | 接口 | 说明 |
|------|------|------|
| GET | `/api/admin/coupons` | 券列表 |
| POST | `/api/admin/coupons/batch-issue` | 批量发券 |
| GET | `/api/admin/coupon-stats` | 券统计（发放/核销/过期） |

#### 11.3.4 配件管理

| 方法 | 接口 | 说明 |
|------|------|------|
| GET | `/api/admin/parts` | 配件列表 |
| POST | `/api/admin/parts` | 新增配件 |
| GET | `/api/admin/parts/stock` | 库存列表 |
| POST | `/api/admin/parts/stock/in` | 入库 |
| GET | `/api/admin/parts/stock/warning` | 库存预警列表 |

#### 11.3.5 排队调度

| 方法 | 接口 | 说明 |
|------|------|------|
| GET | `/api/admin/queue` | 当前排队列表 |
| POST | `/api/admin/queue/{id}/assign` | 分配工位 |
| POST | `/api/admin/queue/{id}/skip` | 跳过（过号） |
| GET | `/api/admin/queue/capacity` | 今日剩余容量 |

#### 11.3.6 统计报表

| 方法 | 接口 | 说明 |
|------|------|------|
| GET | `/api/admin/stats/overview` | 总览（今日订单/收入/工位利用率） |
| GET | `/api/admin/stats/service` | 服务类型统计 |
| GET | `/api/admin/stats/employee` | 员工绩效统计 |
| GET | `/api/admin/stats/trend` | 趋势图数据（日/周/月） |

---

### 11.4 摄像头回调 API（内部）

| 方法 | 接口 | 说明 |
|------|------|------|
| POST | `/api/internal/camera/plate-event` | 车牌识别事件回调 |

```json
// POST /api/internal/camera/plate-event
// Request (摄像头推送)
{
  "cameraId": "CAM001",
  "plateNo": "粤B12345",
  "plateColor": "蓝",
  "confidence": 0.95,
  "captureTime": "2026-01-19T14:30:00+08:00",
  "imageBase64": "..."
}
// Response
{ "code": 0 }
```

---

## 十二、摄像头对接 POC

### 12.1 目标

跑通 DS-2CD3646WDV3-LZ 的 ISAPI 车牌识别，验证：
1. 能否通过 ISAPI 获取车牌识别结果
2. 能否订阅实时车牌识别事件
3. 识别准确率和延迟

### 12.2 设备信息

| 项目 | 值 |
|------|-----|
| 型号 | DS-2CD3646WDV3-LZ |
| 协议 | ISAPI（HTTP RESTful） |
| 认证 | Digest Auth |
| 默认端口 | 80（HTTP）/ 443（HTTPS） |

### 12.3 POC 步骤

#### Step 1：基础连通性验证

```bash
# 测试摄像头连通性
curl -X GET "http://<CAMERA_IP>/ISAPI/System/deviceInfo" \
  --digest -u admin:password

# 预期响应
<?xml version="1.0" encoding="UTF-8"?>
<DeviceInfo>
  <deviceName>DS-2CD3646WDV3-LZ</deviceName>
  <model>DS-2CD3646WDV3-LZ</model>
  ...
</DeviceInfo>
```

#### Step 2：获取车牌识别通道配置

```bash
# 查询智能分析通道
curl -X GET "http://<CAMERA_IP>/ISAPI/Traffic/channels" \
  --digest -u admin:password
```

#### Step 3：触发手动抓拍

```bash
# 手动触发抓拍
curl -X PUT "http://<CAMERA_IP>/ISAPI/Traffic/channels/1/vehicleDetect/manualCapture" \
  --digest -u admin:password \
  -H "Content-Type: application/xml" \
  -d '<ManualCapture><captureNumber>1</captureNumber></ManualCapture>'
```

#### Step 4：订阅车牌识别事件（推荐方式）

```bash
# 订阅事件流（长连接）
curl -X GET "http://<CAMERA_IP>/ISAPI/Event/notification/alertStream" \
  --digest -u admin:password \
  --no-buffer

# 事件格式（multipart）
--boundary
Content-Type: application/json

{
  "ipAddress": "192.168.1.100",
  "eventType": "ANPR",
  "dateTime": "2026-01-19T14:30:00+08:00",
  "ANPR": {
    "licensePlate": "粤B12345",
    "plateColor": "蓝",
    "confidence": 95,
    "direction": "approach"
  }
}
--boundary
Content-Type: image/jpeg

<binary image data>
--boundary--
```

#### Step 5：Java 集成代码

```java
@Service
@Slf4j
public class HikCameraService {
    
    private final RestTemplate restTemplate;
    private final StationService stationService;
    
    /**
     * 订阅摄像头事件（启动时调用）
     */
    @PostConstruct
    public void subscribeAllCameras() {
        List<Station> stations = stationService.findAllWithCamera();
        for (Station station : stations) {
            CompletableFuture.runAsync(() -> 
                subscribeCamera(station.getCameraIp(), station.getId())
            );
        }
    }
    
    /**
     * 订阅单个摄像头
     */
    private void subscribeCamera(String cameraIp, Long stationId) {
        String url = String.format("http://%s/ISAPI/Event/notification/alertStream", cameraIp);
        
        // 使用 WebClient 或 OkHttp 保持长连接
        webClient.get()
            .uri(url)
            .headers(h -> h.setBasicAuth("admin", "password"))  // 实际用 Digest
            .retrieve()
            .bodyToFlux(String.class)
            .subscribe(event -> handlePlateEvent(event, stationId));
    }
    
    /**
     * 处理车牌识别事件
     */
    private void handlePlateEvent(String eventJson, Long stationId) {
        PlateEvent event = parseEvent(eventJson);
        log.info("摄像头识别车牌: stationId={}, plate={}", stationId, event.getPlateNo());
        
        // 更新工位当前车牌
        stationService.updateCurrentPlate(stationId, event.getPlateNo(), event.getImageUrl());
    }
}
```

### 12.4 POC 验收标准

| 验收项 | 标准 |
|--------|------|
| 连通性 | 能获取设备信息 |
| 抓拍 | 手动触发抓拍返回车牌 |
| 事件订阅 | 车辆经过时能收到事件推送 |
| 识别率 | 白天 > 95%，夜间 > 90% |
| 延迟 | 车辆入位到收到事件 < 2秒 |
| 稳定性 | 长连接保持 > 24小时不断 |

### 12.5 备选方案

如果 ISAPI 事件订阅不稳定，备选方案：

| 方案 | 说明 | 优缺点 |
|------|------|--------|
| **轮询模式** | 定时查询最新识别结果 | 简单可靠，但有延迟 |
| **海康SDK** | 使用官方Java SDK | 功能全，但依赖重 |
| **萤石云** | 通过云端获取事件 | 需额外订阅费用 |

---

## 十三、公众号模板消息申请

### 13.1 需要申请的模板

| 场景 | 模板名称 | 所属类目 | 优先级 |
|------|----------|----------|--------|
| 配件到货 | 商品到货通知 | 购物 - 订单物流 | P0 |
| 服务完成 | 服务完成通知 | 汽车服务 - 服务进度 | P0 |
| 排队叫号 | 排队叫号通知 | 生活服务 - 预约排队 | P1 |
| 追加确认 | 订单确认通知 | 购物 - 订单状态 | P1 |

### 13.2 模板详情

#### 模板1：配件到货通知

```
模板名称：商品到货通知
所属类目：购物 - 订单物流

模板内容：
{{first.DATA}}
商品名称：{{keyword1.DATA}}
商品规格：{{keyword2.DATA}}
门店名称：{{keyword3.DATA}}
{{remark.DATA}}

示例：
您预约的配件已到货
商品名称：米其林轮胎
商品规格：225/45R17
门店名称：XX加油站洗车中心
请尽快到店安装，有效期7天。
```

#### 模板2：服务完成通知

```
模板名称：服务完成通知
所属类目：汽车服务 - 服务进度

模板内容：
{{first.DATA}}
车牌号码：{{keyword1.DATA}}
服务项目：{{keyword2.DATA}}
完成时间：{{keyword3.DATA}}
{{remark.DATA}}

示例：
您的爱车已服务完成
车牌号码：粤B12345
服务项目：洗车+打蜡
完成时间：2026-01-19 15:30
请及时取车，祝您驾驶愉快！
```

#### 模板3：排队叫号通知

```
模板名称：排队叫号通知
所属类目：生活服务 - 预约排队

模板内容：
{{first.DATA}}
排队号码：{{keyword1.DATA}}
工位名称：{{keyword2.DATA}}
{{remark.DATA}}

示例：
轮到您了，请进场
排队号码：A015
工位名称：1号位
请在5分钟内驶入，超时将过号。
```

#### 模板4：追加服务确认通知

```
模板名称：订单确认通知
所属类目：购物 - 订单状态

模板内容：
{{first.DATA}}
服务项目：{{keyword1.DATA}}
服务金额：{{keyword2.DATA}}
{{remark.DATA}}

示例：
员工为您推荐了追加服务
服务项目：打蜡服务、内饰清洁
服务金额：¥230.00
点击确认并支付，或回复"取消"拒绝。
```

### 13.3 申请流程

```
1. 登录微信公众平台 → 功能 → 模板消息
2. 从模板库选择（优先）或申请新模板
3. 填写使用场景说明
4. 等待审核（1-3个工作日）
5. 审核通过后获取 template_id
```

### 13.4 申请前准备

| 准备项 | 说明 | 状态 |
|--------|------|------|
| 公众号已认证 | 需要认证服务号 | [ ] 确认 |
| 开通模板消息 | 功能 → 添加功能插件 → 模板消息 | [ ] 确认 |
| 类目已添加 | 汽车服务、购物等相关类目 | [ ] 确认 |
| 场景说明 | 每个模板的使用场景文档 | [ ] 准备 |

### 13.5 代码集成

```java
@Service
public class WxTemplateService {
    
    @Value("${wx.appid}")
    private String appId;
    
    private final WxMpService wxMpService;
    
    // 模板ID（审核通过后填入）
    private static final String TPL_PART_ARRIVE = "xxx";      // 配件到货
    private static final String TPL_SERVICE_DONE = "xxx";     // 服务完成
    private static final String TPL_QUEUE_CALL = "xxx";       // 排队叫号
    private static final String TPL_ADDON_CONFIRM = "xxx";    // 追加确认
    
    /**
     * 发送配件到货通知
     */
    public void sendPartArriveNotice(String openId, String partName, String spec, String siteName) {
        WxMpTemplateMessage msg = WxMpTemplateMessage.builder()
            .toUser(openId)
            .templateId(TPL_PART_ARRIVE)
            .url("https://xxx.com/user/part-orders")  // 跳转链接
            .build();
        
        msg.addData(new WxMpTemplateData("first", "您预约的配件已到货"));
        msg.addData(new WxMpTemplateData("keyword1", partName));
        msg.addData(new WxMpTemplateData("keyword2", spec));
        msg.addData(new WxMpTemplateData("keyword3", siteName));
        msg.addData(new WxMpTemplateData("remark", "请尽快到店安装，有效期7天。"));
        
        wxMpService.getTemplateMsgService().sendTemplateMsg(msg);
    }
    
    /**
     * 发送服务完成通知
     */
    public void sendServiceDoneNotice(String openId, String plateNo, String services, String finishTime) {
        WxMpTemplateMessage msg = WxMpTemplateMessage.builder()
            .toUser(openId)
            .templateId(TPL_SERVICE_DONE)
            .url("https://xxx.com/user/orders")
            .build();
        
        msg.addData(new WxMpTemplateData("first", "您的爱车已服务完成"));
        msg.addData(new WxMpTemplateData("keyword1", plateNo));
        msg.addData(new WxMpTemplateData("keyword2", services));
        msg.addData(new WxMpTemplateData("keyword3", finishTime));
        msg.addData(new WxMpTemplateData("remark", "请及时取车，祝您驾驶愉快！"));
        
        wxMpService.getTemplateMsgService().sendTemplateMsg(msg);
    }
}
```

---

## 变更记录

| 日期 | 版本 | 变更内容 |
|------|------|----------|
| 2026-01-19 | v0.1 | 初稿，基于需求描述整理 |
| 2026-01-19 | v0.2 | 补充多端角色分析、排队调度、绩效统计、外观检查设计 |
| 2026-01-19 | v0.3 | 新增配件库设计、排队容量计算逻辑、更新已确认事项 |
| 2026-01-19 | v0.4 | 新增配件预约到货流程（用户待处理清单）、追加服务确认机制、服务配置开关 |
| 2026-01-19 | v0.5 | 确认技术栈(SpringBoot+Vue2)、摄像头型号(DS-2CD3646WDV3-LZ)、通知方式(公众号)，所有问题确认完成 |
| 2026-01-19 | v0.6 | 新增数据库DDL设计、各端API接口设计、摄像头ISAPI对接POC、公众号模板消息申请清单 |
