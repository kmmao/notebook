# 汽车美容服务 - 公众号模板消息申请

> 微信公众号模板消息申请清单及集成指南
> 
> **待办**：提前申请模板ID，避免阻塞开发

## 一、申请前准备

### 1.1 准备清单

| 准备项 | 说明 | 状态 |
|--------|------|------|
| 公众号已认证 | 需要认证服务号（订阅号不支持模板消息） | [ ] 确认 |
| 开通模板消息 | 功能 → 添加功能插件 → 模板消息 | [ ] 确认 |
| 类目已添加 | 汽车服务、购物、生活服务等相关类目 | [ ] 确认 |
| 场景说明 | 每个模板的使用场景文档 | [ ] 准备 |

### 1.2 公众号信息

| 项目 | 值 | 备注 |
|------|-----|------|
| 公众号名称 | - | 待填写 |
| AppID | - | 待填写 |
| 公众号类型 | 服务号 | 必须是认证服务号 |
| 已有类目 | - | 待确认 |

---

## 二、需要申请的模板

### 2.1 模板清单

| 场景 | 模板名称 | 所属类目 | 优先级 | 状态 |
|------|----------|----------|--------|------|
| 配件到货 | 商品到货通知 | 购物 - 订单物流 | P0 | [ ] |
| 服务完成 | 服务完成通知 | 汽车服务 - 服务进度 | P0 | [ ] |
| 排队叫号 | 排队叫号通知 | 生活服务 - 预约排队 | P1 | [ ] |
| 追加确认 | 订单确认通知 | 购物 - 订单状态 | P1 | [ ] |

---

## 三、模板详情

### 3.1 模板1：配件到货通知

**基本信息**：
| 项目 | 值 |
|------|-----|
| 模板名称 | 商品到货通知 |
| 所属类目 | 购物 - 订单物流 |
| 使用场景 | 用户预约的配件到货后通知用户到店安装 |

**模板内容**：
```
{{first.DATA}}
商品名称：{{keyword1.DATA}}
商品规格：{{keyword2.DATA}}
门店名称：{{keyword3.DATA}}
{{remark.DATA}}
```

**字段说明**：
| 字段 | 说明 | 示例值 |
|------|------|--------|
| first | 通知标题 | 您预约的配件已到货 |
| keyword1 | 商品名称 | 米其林轮胎 |
| keyword2 | 商品规格 | 225/45R17 |
| keyword3 | 门店名称 | XX加油站洗车中心 |
| remark | 备注说明 | 请尽快到店安装，有效期7天。 |

**效果预览**：
```
┌─────────────────────────────────┐
│  🔔 您预约的配件已到货            │
│                                  │
│  商品名称：米其林轮胎             │
│  商品规格：225/45R17              │
│  门店名称：XX加油站洗车中心        │
│                                  │
│  请尽快到店安装，有效期7天。       │
│                                  │
│  [点击查看详情]                   │
└─────────────────────────────────┘
```

---

### 3.2 模板2：服务完成通知

**基本信息**：
| 项目 | 值 |
|------|-----|
| 模板名称 | 服务完成通知 |
| 所属类目 | 汽车服务 - 服务进度 |
| 使用场景 | 洗车/美容服务完成后通知用户取车 |

**模板内容**：
```
{{first.DATA}}
车牌号码：{{keyword1.DATA}}
服务项目：{{keyword2.DATA}}
完成时间：{{keyword3.DATA}}
{{remark.DATA}}
```

**字段说明**：
| 字段 | 说明 | 示例值 |
|------|------|--------|
| first | 通知标题 | 您的爱车已服务完成 |
| keyword1 | 车牌号码 | 粤B12345 |
| keyword2 | 服务项目 | 洗车+打蜡 |
| keyword3 | 完成时间 | 2026-01-19 15:30 |
| remark | 备注说明 | 请及时取车，祝您驾驶愉快！ |

**效果预览**：
```
┌─────────────────────────────────┐
│  🚗 您的爱车已服务完成            │
│                                  │
│  车牌号码：粤B12345               │
│  服务项目：洗车+打蜡              │
│  完成时间：2026-01-19 15:30       │
│                                  │
│  请及时取车，祝您驾驶愉快！        │
│                                  │
│  [点击查看详情]                   │
└─────────────────────────────────┘
```

---

### 3.3 模板3：排队叫号通知

**基本信息**：
| 项目 | 值 |
|------|-----|
| 模板名称 | 排队叫号通知 |
| 所属类目 | 生活服务 - 预约排队 |
| 使用场景 | 轮到用户时通知进入指定工位 |

**模板内容**：
```
{{first.DATA}}
排队号码：{{keyword1.DATA}}
工位名称：{{keyword2.DATA}}
{{remark.DATA}}
```

**字段说明**：
| 字段 | 说明 | 示例值 |
|------|------|--------|
| first | 通知标题 | 轮到您了，请进场 |
| keyword1 | 排队号码 | A015 |
| keyword2 | 工位名称 | 1号位 |
| remark | 备注说明 | 请在5分钟内驶入，超时将过号。 |

**效果预览**：
```
┌─────────────────────────────────┐
│  📢 轮到您了，请进场              │
│                                  │
│  排队号码：A015                   │
│  工位名称：1号位                  │
│                                  │
│  请在5分钟内驶入，超时将过号。     │
│                                  │
│  [点击查看详情]                   │
└─────────────────────────────────┘
```

---

### 3.4 模板4：追加服务确认通知

**基本信息**：
| 项目 | 值 |
|------|-----|
| 模板名称 | 订单确认通知 |
| 所属类目 | 购物 - 订单状态 |
| 使用场景 | 员工为用户推荐追加服务后通知用户确认 |

**模板内容**：
```
{{first.DATA}}
服务项目：{{keyword1.DATA}}
服务金额：{{keyword2.DATA}}
{{remark.DATA}}
```

**字段说明**：
| 字段 | 说明 | 示例值 |
|------|------|--------|
| first | 通知标题 | 员工为您推荐了追加服务 |
| keyword1 | 服务项目 | 打蜡服务、内饰清洁 |
| keyword2 | 服务金额 | ¥230.00 |
| remark | 备注说明 | 点击确认并支付，或回复"取消"拒绝。 |

**效果预览**：
```
┌─────────────────────────────────┐
│  💡 员工为您推荐了追加服务         │
│                                  │
│  服务项目：打蜡服务、内饰清洁      │
│  服务金额：¥230.00               │
│                                  │
│  点击确认并支付，或回复"取消"拒绝。│
│                                  │
│  [点击确认并支付]                 │
└─────────────────────────────────┘
```

---

## 四、申请流程

### 4.1 从模板库选择（推荐）

```
1. 登录微信公众平台（mp.weixin.qq.com）
2. 左侧菜单 → 功能 → 模板消息
3. 点击「从模板库中添加」
4. 搜索对应模板名称（如"商品到货通知"）
5. 选择需要的字段（keyword1, keyword2, keyword3）
6. 点击「添加」
7. 获取 template_id
```

### 4.2 申请新模板（如模板库无合适模板）

```
1. 登录微信公众平台
2. 左侧菜单 → 功能 → 模板消息
3. 点击「申请新模板」
4. 选择所属类目
5. 填写模板标题和关键词
6. 填写使用场景说明
7. 提交审核（1-3个工作日）
```

### 4.3 使用场景说明模板

```
【场景名称】配件到货通知

【使用场景】
用户在汽车美容服务中心预约了轮胎、雨刮等配件，当配件到货时，
系统自动向用户发送到货通知，提醒用户到店安装。

【发送时机】
配件入库确认后，系统自动触发发送。

【预计发送量】
每月约 500-1000 条。

【用户价值】
及时通知用户配件已到货，避免用户反复询问，提升服务体验。
```

---

## 五、模板 ID 记录

申请通过后，填写获取到的 template_id：

| 模板名称 | template_id | 申请时间 | 状态 |
|----------|-------------|----------|------|
| 商品到货通知 | - | - | [ ] 待申请 |
| 服务完成通知 | - | - | [ ] 待申请 |
| 排队叫号通知 | - | - | [ ] 待申请 |
| 订单确认通知 | - | - | [ ] 待申请 |

---

## 六、代码集成

### 6.1 添加依赖

```xml
<!-- pom.xml -->
<dependency>
    <groupId>com.github.binarywang</groupId>
    <artifactId>weixin-java-mp</artifactId>
    <version>4.5.0</version>
</dependency>
```

### 6.2 配置类

```java
@Configuration
public class WxMpConfig {
    
    @Value("${wx.mp.appId}")
    private String appId;
    
    @Value("${wx.mp.secret}")
    private String secret;
    
    @Bean
    public WxMpService wxMpService() {
        WxMpDefaultConfigImpl config = new WxMpDefaultConfigImpl();
        config.setAppId(appId);
        config.setSecret(secret);
        
        WxMpService wxMpService = new WxMpServiceImpl();
        wxMpService.setWxMpConfigStorage(config);
        return wxMpService;
    }
}
```

### 6.3 模板消息服务

```java
@Service
@Slf4j
public class WxTemplateService {
    
    @Autowired
    private WxMpService wxMpService;
    
    // 模板ID（审核通过后填入）
    private static final String TPL_PART_ARRIVE = "xxx";      // 配件到货
    private static final String TPL_SERVICE_DONE = "xxx";     // 服务完成
    private static final String TPL_QUEUE_CALL = "xxx";       // 排队叫号
    private static final String TPL_ADDON_CONFIRM = "xxx";    // 追加确认
    
    /**
     * 发送配件到货通知
     */
    public void sendPartArriveNotice(String openId, String partName, String spec, String siteName) {
        try {
            WxMpTemplateMessage msg = WxMpTemplateMessage.builder()
                .toUser(openId)
                .templateId(TPL_PART_ARRIVE)
                .url("https://xxx.com/user/part-orders")
                .build();
            
            msg.addData(new WxMpTemplateData("first", "您预约的配件已到货"));
            msg.addData(new WxMpTemplateData("keyword1", partName));
            msg.addData(new WxMpTemplateData("keyword2", spec));
            msg.addData(new WxMpTemplateData("keyword3", siteName));
            msg.addData(new WxMpTemplateData("remark", "请尽快到店安装，有效期7天。"));
            
            String msgId = wxMpService.getTemplateMsgService().sendTemplateMsg(msg);
            log.info("发送配件到货通知成功: openId={}, msgId={}", openId, msgId);
        } catch (WxErrorException e) {
            log.error("发送配件到货通知失败: openId={}, error={}", openId, e.getMessage());
        }
    }
    
    /**
     * 发送服务完成通知
     */
    public void sendServiceDoneNotice(String openId, String plateNo, String services, String finishTime) {
        try {
            WxMpTemplateMessage msg = WxMpTemplateMessage.builder()
                .toUser(openId)
                .templateId(TPL_SERVICE_DONE)
                .url("https://xxx.com/user/orders")
                .build();
            
            msg.addData(new WxMpTemplateData("first", "您的爱车已服务完成"));
            msg.addData(new WxMpTemplateData("keyword1", plateNo));
            msg.addData(new WxMpTemplateData("keyword2", services));
            msg.addData(new WxMpTemplateData("keyword3", finishTime));
            msg.addData(new WxMpTemplateData("remark", "请及时取车，祝您驾驶愉快！"));
            
            String msgId = wxMpService.getTemplateMsgService().sendTemplateMsg(msg);
            log.info("发送服务完成通知成功: openId={}, msgId={}", openId, msgId);
        } catch (WxErrorException e) {
            log.error("发送服务完成通知失败: openId={}, error={}", openId, e.getMessage());
        }
    }
    
    /**
     * 发送排队叫号通知
     */
    public void sendQueueCallNotice(String openId, String queueNo, String stationName) {
        try {
            WxMpTemplateMessage msg = WxMpTemplateMessage.builder()
                .toUser(openId)
                .templateId(TPL_QUEUE_CALL)
                .url("https://xxx.com/user/queue")
                .build();
            
            msg.addData(new WxMpTemplateData("first", "轮到您了，请进场"));
            msg.addData(new WxMpTemplateData("keyword1", queueNo));
            msg.addData(new WxMpTemplateData("keyword2", stationName));
            msg.addData(new WxMpTemplateData("remark", "请在5分钟内驶入，超时将过号。"));
            
            String msgId = wxMpService.getTemplateMsgService().sendTemplateMsg(msg);
            log.info("发送排队叫号通知成功: openId={}, msgId={}", openId, msgId);
        } catch (WxErrorException e) {
            log.error("发送排队叫号通知失败: openId={}, error={}", openId, e.getMessage());
        }
    }
    
    /**
     * 发送追加服务确认通知
     */
    public void sendAddonConfirmNotice(String openId, String services, String amount, Long orderId) {
        try {
            WxMpTemplateMessage msg = WxMpTemplateMessage.builder()
                .toUser(openId)
                .templateId(TPL_ADDON_CONFIRM)
                .url("https://xxx.com/user/orders/" + orderId + "/confirm")
                .build();
            
            msg.addData(new WxMpTemplateData("first", "员工为您推荐了追加服务"));
            msg.addData(new WxMpTemplateData("keyword1", services));
            msg.addData(new WxMpTemplateData("keyword2", "¥" + amount));
            msg.addData(new WxMpTemplateData("remark", "点击确认并支付，或回复\"取消\"拒绝。"));
            
            String msgId = wxMpService.getTemplateMsgService().sendTemplateMsg(msg);
            log.info("发送追加确认通知成功: openId={}, msgId={}", openId, msgId);
        } catch (WxErrorException e) {
            log.error("发送追加确认通知失败: openId={}, error={}", openId, e.getMessage());
        }
    }
}
```

### 6.4 配置文件

```yaml
# application.yml
wx:
  mp:
    appId: ${WX_MP_APP_ID}
    secret: ${WX_MP_SECRET}
```

---

## 七、测试验证

### 7.1 测试账号

| 项目 | 值 |
|------|-----|
| 测试 openId | - |
| 测试手机号 | - |

### 7.2 测试用例

| 场景 | 预期结果 | 实际结果 | 状态 |
|------|----------|----------|------|
| 配件到货通知 | 收到模板消息，点击跳转正确 | - | [ ] |
| 服务完成通知 | 收到模板消息，点击跳转正确 | - | [ ] |
| 排队叫号通知 | 收到模板消息，点击跳转正确 | - | [ ] |
| 追加确认通知 | 收到模板消息，点击跳转正确 | - | [ ] |

---

## 八、注意事项

### 8.1 发送限制

| 限制项 | 说明 |
|--------|------|
| 发送频率 | 同一用户同一模板每天最多 3 条 |
| 内容长度 | 每个字段最长 200 字符 |
| 跳转链接 | 必须是已认证的域名 |

### 8.2 用户授权

- 用户必须关注公众号才能收到模板消息
- 用户可在公众号中关闭模板消息通知
- 需记录用户的 openId 用于发送

### 8.3 错误处理

| 错误码 | 说明 | 处理方式 |
|--------|------|----------|
| 43004 | 用户未关注公众号 | 记录日志，不重试 |
| 43101 | 用户拒绝接收消息 | 记录日志，不重试 |
| 45015 | 回复时间超过限制 | 检查发送时机 |
| 40037 | 模板ID不正确 | 检查配置 |

---

## 九、待办事项

| # | 任务 | 负责人 | 状态 |
|---|------|--------|------|
| 1 | 确认公众号类型和认证状态 | - | [ ] |
| 2 | 确认已开通模板消息功能 | - | [ ] |
| 3 | 申请4个模板 | - | [ ] |
| 4 | 记录 template_id | - | [ ] |
| 5 | 集成代码开发 | - | [ ] |
| 6 | 测试验证 | - | [ ] |
